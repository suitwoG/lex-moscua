// Prisma schema for Lex Moscua platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  AUTHOR
  LEARNER
}

enum LessonStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum TaskKind {
  MULTIPLE_CHOICE
  TRUE_FALSE
  ORDERING
  FILL_IN
  SHORT_ANSWER
  MATERIAL
}

enum LessonProgressStatus {
  LOCKED
  AVAILABLE
  IN_PROGRESS
  COMPLETED
  MASTERED
}

enum XpReason {
  LESSON_COMPLETE
  DAILY_GOAL
  STREAK_BONUS
  REVIEW_SESSION
  ADMIN_ADJUSTMENT
}

enum StreakEventType {
  INCREMENT
  RESET
  SHIELD_USED
}

enum DailyChallengeType {
  COMPLETE_LESSONS
  EARN_XP
  PERFECT_SCORE
  REVIEW_LESSONS
}

enum DailyChallengeStatus {
  PENDING
  COMPLETED
  EXPIRED
}

enum ShopItemCategory {
  BOOSTER
  COSMETIC
  UTILITY
}

enum ShopItemStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String?
  passwordHash    String
  role            UserRole  @default(LEARNER)
  locale          String    @default("ru")
  timeZone        String    @default("Europe/Moscow")
  avatarUrl       String?
  xp              Int       @default(0)
  coins           Int       @default(0)
  streakCount     Int       @default(0)
  longestStreak   Int       @default(0)
  dailyGoal       Int       @default(20)
  lastGoalResetAt DateTime? @default(now())
  currentCourseId String?
  currentCourse   Course?   @relation("UserCurrentCourse", fields: [currentCourseId], references: [id], onDelete: SetNull)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  authenticators   Authenticator[]
  enrollments      CourseEnrollment[]
  lessonProgresses LessonProgress[]
  xpEvents         XpEvent[]
  streakEvents     StreakEvent[]
  dailyGoalLogs    DailyGoalLog[]
  dailyChallenges  UserDailyChallenge[]
  purchases        UserPurchase[]

  @@index([role])
}

model Course {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String?
  language    String   @default("ru")
  icon        String?
  isPublished Boolean  @default(false)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  modules      CourseModule[]
  enrollments  CourseEnrollment[]
  xpEvents     XpEvent[]
  challenges   DailyChallenge[]
  currentUsers User[]             @relation("UserCurrentCourse")

  @@index([language])
  @@index([isPublished, order])
}

model CourseModule {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String?
  order       Int      @default(0)
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course             Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons            Lesson[]
  currentEnrollments CourseEnrollment[] @relation("EnrollmentCurrentModule")

  @@unique([courseId, order])
}

model Lesson {
  id           String       @id @default(cuid())
  moduleId     String
  slug         String       @unique
  title        String
  summary      String?
  content      Json?
  order        Int          @default(0)
  xpReward     Int          @default(20)
  status       LessonStatus @default(DRAFT)
  isAssessment Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  module           CourseModule       @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  tasks            LessonTask[]
  progresses       LessonProgress[]
  xpEvents         XpEvent[]
  currentEnrollees CourseEnrollment[] @relation("EnrollmentCurrentLesson")

  @@unique([moduleId, order])
}

model LessonTask {
  id        String   @id @default(cuid())
  lessonId  String
  kind      TaskKind
  prompt    String
  order     Int      @default(0)
  payload   Json
  solution  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([lessonId, order])
}

model CourseEnrollment {
  id              String    @id @default(cuid())
  userId          String
  courseId        String
  level           Int       @default(1)
  xp              Int       @default(0)
  coins           Int       @default(0)
  progressPercent Int       @default(0)
  streakCount     Int       @default(0)
  lastActivityAt  DateTime?
  activatedAt     DateTime  @default(now())
  isActive        Boolean   @default(true)
  currentModuleId String?
  currentLessonId String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  course        Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  currentModule CourseModule? @relation("EnrollmentCurrentModule", fields: [currentModuleId], references: [id], onDelete: SetNull)
  currentLesson Lesson?       @relation("EnrollmentCurrentLesson", fields: [currentLessonId], references: [id], onDelete: SetNull)

  @@unique([userId, courseId])
  @@index([courseId, isActive])
}

model LessonProgress {
  id            String               @id @default(cuid())
  userId        String
  lessonId      String
  status        LessonProgressStatus @default(LOCKED)
  attempts      Int                  @default(0)
  score         Int?                 @default(0)
  stars         Int?                 @default(0)
  lastAttemptAt DateTime?
  completedAt   DateTime?
  xpEarned      Int                  @default(0)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model XpEvent {
  id        String   @id @default(cuid())
  userId    String
  courseId  String?
  lessonId  String?
  amount    Int
  reason    XpReason @default(LESSON_COMPLETE)
  createdAt DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  lesson Lesson? @relation(fields: [lessonId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
}

model StreakEvent {
  id        String          @id @default(cuid())
  userId    String
  day       DateTime
  type      StreakEventType
  delta     Int             @default(1)
  createdAt DateTime        @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, day, type])
}

model DailyGoalLog {
  id         String   @id @default(cuid())
  userId     String
  goal       Int      @default(20)
  achieved   Boolean  @default(false)
  xpEarned   Int      @default(0)
  streakKept Boolean  @default(true)
  date       DateTime
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

model DailyChallenge {
  id          String             @id @default(cuid())
  courseId    String?
  type        DailyChallengeType
  target      Int                @default(1)
  rewardXp    Int                @default(20)
  rewardCoins Int                @default(20)
  startsAt    DateTime
  endsAt      DateTime
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  course      Course?              @relation(fields: [courseId], references: [id], onDelete: SetNull)
  assignments UserDailyChallenge[]
}

model UserDailyChallenge {
  id          String               @id @default(cuid())
  userId      String
  challengeId String
  status      DailyChallengeStatus @default(PENDING)
  progress    Int                  @default(0)
  completedAt DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge DailyChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
}

model ShopItem {
  id          String           @id @default(cuid())
  slug        String           @unique
  title       String
  description String?
  category    ShopItemCategory @default(BOOSTER)
  status      ShopItemStatus   @default(DRAFT)
  cost        Int              @default(100)
  stock       Int              @default(0)
  isUnlimited Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  purchases UserPurchase[]
}

model UserPurchase {
  id          String   @id @default(cuid())
  userId      String
  itemId      String
  quantity    Int      @default(1)
  purchasedAt DateTime @default(now())

  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  item ShopItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
}

// NextAuth.js supporting models

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Authenticator {
  id                  String  @id @default(cuid())
  userId              String
  credentialId        String  @unique
  provider            String
  credentialPublicKey String
  counter             Int
  transports          String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
